<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GlucoTrack Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-dark { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, 
            ResponsiveContainer, ReferenceLine, AreaChart, Area 
        } = Recharts;

        // --- COMPOSANTS ICONES ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{width: size, height: size}} className={className}></i>;
        };

        const GlucoTrack = () => {
            // √âtat Global
            const [activeTab, setActiveTab] = useState('today');
            const [entries, setEntries] = useState([]);
            const [allEntries, setAllEntries] = useState({});
            const [showAddForm, setShowAddForm] = useState(false);
            const [showUserSelect, setShowUserSelect] = useState(true);
            const [currentUser, setCurrentUser] = useState(null);
            const [users, setUsers] = useState([]);
            const [newUserName, setNewUserName] = useState('');
            const [darkMode, setDarkMode] = useState(true);
            const [loading, setLoading] = useState(true);
            const [badges, setBadges] = useState([]);
            
            // √âtat Formulaire
            const [formData, setFormData] = useState({
                moment: 'matin_jeun',
                glucose: '',
                measureTime: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                meal: 'none',
                mealContent: '',
                medications: [],
                comment: ''
            });

            // Initialisation & Chargement
            useEffect(() => {
                const savedUsers = localStorage.getItem('gt_users');
                if (savedUsers) setUsers(JSON.parse(savedUsers));
                setLoading(false);
            }, []);

            useEffect(() => {
                if (currentUser) {
                    const savedData = localStorage.getItem(`gt_data_${currentUser.id}`);
                    if (savedData) {
                        const parsed = JSON.parse(savedData);
                        setAllEntries(parsed.allEntries || {});
                        const today = new Date().toISOString().split('T')[0];
                        setEntries(parsed.allEntries?.[today] || []);
                        setBadges(parsed.badges || []);
                    }
                }
            }, [currentUser]);

            // Sauvegarde automatique
            const persistData = (updatedAllEntries, updatedBadges) => {
                const dataToSave = { allEntries: updatedAllEntries, badges: updatedBadges };
                localStorage.setItem(`gt_data_${currentUser.id}`, JSON.stringify(dataToSave));
            };

            // Logique Utilisateurs
            const handleCreateUser = () => {
                if (!newUserName.trim()) return;
                const newUser = { id: Date.now().toString(), name: newUserName, avatar: 'üë§' };
                const updated = [...users, newUser];
                setUsers(updated);
                localStorage.setItem('gt_users', JSON.stringify(updated));
                setCurrentUser(newUser);
                setShowUserSelect(false);
            };

            // Ajout de mesure
            const saveEntry = () => {
                if (!formData.glucose) return;
                const today = new Date().toISOString().split('T')[0];
                const newEntry = {
                    ...formData,
                    id: Date.now(),
                    glucose: parseFloat(formData.glucose),
                    timestamp: new Date().toISOString()
                };

                const updatedDayEntries = [...entries, newEntry];
                const updatedAll = { ...allEntries, [today]: updatedDayEntries };
                
                setEntries(updatedDayEntries);
                setAllEntries(updatedAll);
                
                // V√©rification Badges
                let newBadges = [...badges];
                if (updatedDayEntries.length === 1 && !newBadges.includes('first')) {
                    newBadges.push('first');
                }
                setBadges(newBadges);

                persistData(updatedAll, newBadges);
                setShowAddForm(false);
                setFormData({ ...formData, glucose: '', comment: '' });
            };

            // Export Excel
            const exportData = () => {
                const flatData = Object.keys(allEntries).flatMap(date => 
                    allEntries[date].map(e => ({
                        Date: date, Heure: e.measureTime, Glycemie: e.glucose, Moment: e.moment, Repas: e.mealContent, Notes: e.comment
                    }))
                );
                const ws = XLSX.utils.json_to_sheet(flatData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Glyc√©mie");
                XLSX.writeFile(wb, `GlucoTrack_${currentUser.name}.xlsx`);
            };

            if (loading) return <div className="min-h-screen bg-slate-950 flex items-center justify-center text-white">Chargement...</div>;

            if (showUserSelect) {
                return (
                    <div className="min-h-screen bg-slate-950 flex items-center justify-center p-6 text-white">
                        <div className="w-full max-w-md space-y-8">
                            <div className="text-center">
                                <h1 className="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">GlucoTrack</h1>
                                <p className="text-slate-400 mt-2">Votre compagnon sant√©</p>
                            </div>
                            <div className="space-y-4">
                                {users.map(u => (
                                    <button key={u.id} onClick={() => {setCurrentUser(u); setShowUserSelect(false)}} 
                                            className="w-full glass p-5 rounded-2xl flex items-center gap-4 hover:bg-white/20 transition-all">
                                        <span className="text-3xl">{u.avatar}</span>
                                        <span className="text-lg font-bold">{u.name}</span>
                                        <Icon name="chevron-right" className="ml-auto text-slate-500" />
                                    </button>
                                ))}
                            </div>
                            <div className="pt-6 border-t border-white/10">
                                <div className="flex gap-2">
                                    <input value={newUserName} onChange={e => setNewUserName(e.target.value)}
                                           className="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-blue-500" 
                                           placeholder="Nom du nouveau profil" />
                                    <button onClick={handleCreateUser} className="bg-blue-600 px-6 rounded-xl font-bold transition-transform active:scale-95">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`min-h-screen ${darkMode ? 'bg-slate-950 text-white' : 'bg-slate-50 text-slate-900'} pb-24 transition-colors duration-300`}>
                    {/* Header */}
                    <header className="p-4 flex justify-between items-center sticky top-0 z-30 backdrop-blur-md border-b border-white/5">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-600 to-cyan-400 flex items-center justify-center font-bold text-white shadow-lg">
                                {currentUser.name[0]}
                            </div>
                            <span className="font-bold text-lg">{currentUser.name}</span>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setDarkMode(!darkMode)} className="p-2 rounded-xl bg-white/5 active:bg-white/10">
                                <Icon name={darkMode ? 'sun' : 'moon'} size={20} />
                            </button>
                            <button onClick={exportData} className="p-2 rounded-xl bg-white/5 text-blue-400">
                                <Icon name="download" size={20} />
                            </button>
                            <button onClick={() => setShowUserSelect(true)} className="p-2 rounded-xl bg-white/5 text-red-400">
                                <Icon name="log-out" size={20} />
                            </button>
                        </div>
                    </header>

                    <main className="max-w-xl mx-auto p-4 space-y-6">
                        {/* Tab Navigation */}
                        <div className="flex p-1 bg-white/5 rounded-2xl gap-1">
                            {['today', 'stats', 'badges'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)}
                                        className={`flex-1 py-3 rounded-xl text-sm font-bold capitalize transition-all ${activeTab === tab ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/40' : 'text-slate-500'}`}>
                                    {tab === 'today' ? "Journal" : tab}
                                </button>
                            ))}
                        </div>

                        {activeTab === 'today' && (
                            <div className="space-y-4">
                                {/* Dashboard Cards */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-gradient-to-br from-blue-600/20 to-transparent p-5 rounded-3xl border border-blue-500/20">
                                        <div className="text-slate-400 text-xs font-bold uppercase tracking-wider">Derni√®re</div>
                                        <div className="text-3xl font-black mt-1">
                                            {entries.length > 0 ? entries[entries.length-1].glucose : '--'}
                                            <span className="text-xs font-normal ml-1 opacity-50 text-white">g/L</span>
                                        </div>
                                    </div>
                                    <div className="bg-gradient-to-br from-purple-600/20 to-transparent p-5 rounded-3xl border border-purple-500/20">
                                        <div className="text-slate-400 text-xs font-bold uppercase tracking-wider">Moyenne</div>
                                        <div className="text-3xl font-black mt-1">
                                            {entries.length > 0 ? (entries.reduce((a,b)=>a+b.glucose,0)/entries.length).toFixed(2) : '--'}
                                            <span className="text-xs font-normal ml-1 opacity-50 text-white">g/L</span>
                                        </div>
                                    </div>
                                </div>

                                {/* Form Button / Form */}
                                {!showAddForm ? (
                                    <button onClick={() => setShowAddForm(true)} 
                                            className="w-full py-5 bg-gradient-to-r from-blue-600 to-cyan-500 rounded-3xl font-black text-lg shadow-xl shadow-blue-900/20 flex items-center justify-center gap-3 active:scale-95 transition-transform">
                                        <Icon name="plus" size={24} /> NOUVELLE MESURE
                                    </button>
                                ) : (
                                    <div className="bg-slate-900 border border-blue-500/30 p-6 rounded-3xl space-y-5 animate-in slide-in-from-top duration-300">
                                        <div className="flex justify-between items-center">
                                            <h3 className="font-bold text-xl">Ajouter</h3>
                                            <button onClick={() => setShowAddForm(false)} className="p-2"><Icon name="x" /></button>
                                        </div>
                                        <div className="space-y-4">
                                            <div className="relative">
                                                <input type="number" step="0.01" value={formData.glucose} 
                                                       onChange={e => setFormData({...formData, glucose: e.target.value})}
                                                       className="w-full bg-slate-950 p-6 rounded-2xl text-4xl font-black text-center text-blue-400 outline-none border-2 border-transparent focus:border-blue-500" 
                                                       placeholder="0.00" autoFocus />
                                                <div className="absolute right-4 bottom-4 text-slate-500 font-bold">g/L</div>
                                            </div>
                                            
                                            <div className="grid grid-cols-2 gap-3">
                                                <select value={formData.moment} onChange={e => setFormData({...formData, moment: e.target.value})}
                                                        className="bg-white/5 p-4 rounded-xl outline-none font-bold">
                                                    <option value="matin_jeun">üåÖ √Ä jeun</option>
                                                    <option value="midi">‚òÄÔ∏è Midi</option>
                                                    <option value="soir">üåô Soir</option>
                                                    <option value="nuit">üåå Nuit</option>
                                                </select>
                                                <input type="time" value={formData.measureTime} 
                                                       onChange={e => setFormData({...formData, measureTime: e.target.value})}
                                                       className="bg-white/5 p-4 rounded-xl font-bold outline-none" />
                                            </div>

                                            <input value={formData.mealContent} onChange={e => setFormData({...formData, mealContent: e.target.value})}
                                                   className="w-full bg-white/5 p-4 rounded-xl outline-none" placeholder="üí¨ Repas ou note..." />
                                            
                                            <button onClick={saveEntry} className="w-full py-4 bg-blue-600 rounded-2xl font-black shadow-lg">VALIDER</button>
                                        </div>
                                    </div>
                                )}

                                {/* Timeline */}
                                <div className="space-y-3 pt-4">
                                    <h4 className="text-sm font-bold text-slate-500 uppercase tracking-widest px-2">Aujourd'hui</h4>
                                    {entries.length === 0 ? (
                                        <div className="text-center py-10 text-slate-600">Aucune donn√©e aujourd'hui</div>
                                    ) : (
                                        entries.slice().reverse().map(entry => (
                                            <div key={entry.id} className="bg-white/5 p-5 rounded-3xl flex items-center justify-between border border-white/5">
                                                <div className="flex items-center gap-4">
                                                    <div className={`w-12 h-12 rounded-2xl flex items-center justify-center font-black text-lg ${entry.glucose > 1.4 ? 'bg-orange-500/20 text-orange-500' : entry.glucose < 0.7 ? 'bg-red-500/20 text-red-500' : 'bg-green-500/20 text-green-500'}`}>
                                                        {entry.glucose}
                                                    </div>
                                                    <div>
                                                        <div className="font-black text-lg">{entry.measureTime}</div>
                                                        <div className="text-sm text-slate-500 flex items-center gap-1">
                                                            <Icon name="utensils" size={12} /> {entry.mealContent || 'Pas de note'}
                                                        </div>
                                                    </div>
                                                </div>
                                                <button className="text-slate-700"><Icon name="chevron-right" /></button>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'stats' && (
                            <div className="space-y-6">
                                <div className="bg-slate-900/50 p-4 rounded-3xl h-72 border border-white/5">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={entries}>
                                            <defs>
                                                <linearGradient id="colorGluc" x1="0" y1="0" x2="0" y2="1">
                                                    <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.3}/>
                                                    <stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/>
                                                </linearGradient>
                                            </defs>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#ffffff05" vertical={false} />
                                            <XAxis dataKey="measureTime" stroke="#475569" fontSize={10} axisLine={false} tickLine={false} />
                                            <YAxis stroke="#475569" fontSize={10} axisLine={false} tickLine={false} domain={[0, 2]} />
                                            <Tooltip contentStyle={{background: '#0f172a', border: 'none', borderRadius: '12px', fontSize: '12px'}} />
                                            <Area type="monotone" dataKey="glucose" stroke="#3b82f6" strokeWidth={3} fillOpacity={1} fill="url(#colorGluc)" />
                                            <ReferenceLine y={1.4} stroke="#f97316" strokeDasharray="5 5" label={{position: 'right', value: 'High', fill: '#f97316', fontSize: 10}} />
                                            <ReferenceLine y={0.7} stroke="#ef4444" strokeDasharray="5 5" label={{position: 'right', value: 'Low', fill: '#ef4444', fontSize: 10}} />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </div>
                                <div className="bg-blue-600/10 p-6 rounded-3xl border border-blue-500/20">
                                    <div className="flex items-center gap-3 mb-4">
                                        <Icon name="trending-up" className="text-blue-400" />
                                        <h3 className="font-bold">Analyse Hebdo</h3>
                                    </div>
                                    <p className="text-sm text-slate-400 leading-relaxed">
                                        Votre glyc√©mie moyenne est stable. Maintenez vos efforts sur les mesures matinales.
                                    </p>
                                </div>
                            </div>
                        )}

                        {activeTab === 'badges' && (
                            <div className="grid grid-cols-2 gap-4">
                                <div className={`p-6 rounded-3xl border flex flex-col items-center text-center gap-3 transition-all ${badges.includes('first') ? 'bg-yellow-500/10 border-yellow-500/40 text-yellow-500' : 'bg-white/5 border-white/5 opacity-30 grayscale'}`}>
                                    <Icon name="award" size={40} />
                                    <div>
                                        <div className="font-black">Pionnier</div>
                                        <div className="text-xs">Premi√®re mesure</div>
                                    </div>
                                </div>
                                <div className={`p-6 rounded-3xl border flex flex-col items-center text-center gap-3 transition-all ${badges.includes('week') ? 'bg-blue-500/10 border-blue-500/40 text-blue-500' : 'bg-white/5 border-white/5 opacity-30 grayscale'}`}>
                                    <Icon name="calendar" size={40} />
                                    <div>
                                        <div className="font-black">R√©gularit√©</div>
                                        <div className="text-xs">7 jours de suivi</div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Bottom Nav */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-slate-950/80 backdrop-blur-xl border-t border-white/5 p-4 flex justify-around items-center z-50">
                        <button onClick={() => setActiveTab('today')} className={`p-3 rounded-2xl transition-all ${activeTab === 'today' ? 'bg-blue-600/20 text-blue-400 scale-110' : 'text-slate-500'}`}>
                            <Icon name="calendar" size={24} />
                        </button>
                        <button onClick={() => setActiveTab('stats')} className={`p-3 rounded-2xl transition-all ${activeTab === 'stats' ? 'bg-blue-600/20 text-blue-400 scale-110' : 'text-slate-500'}`}>
                            <Icon name="trending-up" size={24} />
                        </button>
                        <button onClick={() => setActiveTab('badges')} className={`p-3 rounded-2xl transition-all ${activeTab === 'badges' ? 'bg-blue-600/20 text-blue-400 scale-110' : 'text-slate-500'}`}>
                            <Icon name="award" size={24} />
                        </button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GlucoTrack />);
    </script>
</body>
</html>
