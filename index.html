<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlucoTrack - Suivi Diab√®te</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --primary: #3b82f6;
            --secondary: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #f8fafc;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; }
        
        body {
            background: linear-gradient(135deg, #0f172a, #1e40af);
            color: var(--text);
            min-height: 100vh;
        }
        
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        
        /* √âcran utilisateur */
        .user-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
        }
        
        .user-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .avatar-btn {
            font-size: 2.5rem;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
        }
        
        .avatar-btn.selected {
            border-color: var(--primary);
            background: rgba(59,130,246,0.2);
        }
        
        /* Interface principale */
        .header {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }
        
        /* Onglets */
        .tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 5px;
            margin: 15px;
            overflow-x: auto;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            color: var(--text);
            border-radius: 8px;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .tab-btn.active {
            background: var(--primary);
        }
        
        /* Formulaire */
        .form-card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid rgba(59,130,246,0.3);
        }
        
        .moment-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .moment-option {
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            text-align: center;
        }
        
        .moment-option.selected {
            border-color: var(--primary);
            background: rgba(59,130,246,0.2);
        }
        
        /* Entr√©es */
        .entry-item {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(30, 64, 175, 0.3));
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .glucose-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            display: inline-block;
        }
        
        /* Badges */
        .badge-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .badge-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .badge-card.unlocked {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        
        /* Utilitaires */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin: 10px 0;
            cursor: pointer;
        }
        
        .input-field {
            width: 100%;
            padding: 14px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- √âcran utilisateur -->
    <div id="userScreen" class="container user-screen">
        <div class="user-card">
            <h1 style="text-align: center; margin-bottom: 30px; font-size: 2.5rem; background: linear-gradient(135deg, #3b82f6, #06b6d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                GlucoTrack
            </h1>
            
            <div id="existingUsers" style="margin-bottom: 30px;"></div>
            
            <h3 style="margin-bottom: 15px; color: var(--secondary);">Nouveau profil :</h3>
            <input type="text" id="userNameInput" class="input-field" placeholder="Nom du patient">
            
            <h4 style="margin: 20px 0 15px 0; color: var(--secondary);">Choisissez un avatar :</h4>
            <div class="avatar-grid" id="avatarGrid">
                <!-- G√©n√©r√© par JavaScript -->
            </div>
            
            <button onclick="createUser()" class="btn-primary" style="margin-top: 20px;">
                Cr√©er le profil
            </button>
        </div>
    </div>
    
    <!-- Application principale -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div id="currentUserAvatar" style="font-size: 2rem;">üë§</div>
                    <div>
                        <h2 id="currentUserName">Utilisateur</h2>
                        <small style="color: #94a3b8;">GlucoTrack</small>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="exportData()" style="background: rgba(255,255,255,0.1); border: none; width: 40px; height: 40px; border-radius: 10px; color: white; cursor: pointer;">
                        üì•
                    </button>
                    <button onclick="showUserScreen()" style="background: rgba(255,255,255,0.1); border: none; width: 40px; height: 40px; border-radius: 10px; color: white; cursor: pointer;">
                        üë•
                    </button>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div style="font-size: 0.8rem; color: #94a3b8;">S√©rie</div>
                    <div id="streakDisplay" style="font-size: 1.5rem; color: var(--primary); font-weight: bold;">0j</div>
                </div>
                <div class="stat-item">
                    <div style="font-size: 0.8rem; color: #94a3b8;">Aujourd'hui</div>
                    <div id="todayCount" style="font-size: 1.5rem; color: var(--secondary); font-weight: bold;">0</div>
                </div>
                <div class="stat-item">
                    <div style="font-size: 0.8rem; color: #94a3b8;">Moyenne</div>
                    <div id="averageDisplay" style="font-size: 1.5rem; font-weight: bold;">0.0</div>
                </div>
                <div class="stat-item">
                    <div style="font-size: 0.8rem; color: #94a3b8;">Objectif</div>
                    <div id="progressDisplay" style="font-size: 1.5rem; color: var(--primary); font-weight: bold;">0%</div>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('today')">üìÖ Aujourd'hui</button>
            <button class="tab-btn" onclick="switchTab('chart')">üìà Courbe</button>
            <button class="tab-btn" onclick="switchTab('stats')">üìä Stats</button>
            <button class="tab-btn" onclick="switchTab('badges')">üèÜ Badges</button>
        </div>
        
        <!-- Contenu -->
        <div class="container">
            <!-- Onglet Aujourd'hui -->
            <div id="tabToday">
                <input type="text" id="searchInput" class="input-field" placeholder="üîç Rechercher glyc√©mie, m√©dicament, repas..." oninput="filterEntries()">
                
                <button id="addButton" onclick="showEntryForm()" class="btn-primary">
                    Ôºã Nouvelle mesure
                </button>
                
                <!-- Formulaire (identique √† React) -->
                <div id="entryForm" class="form-card hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--secondary);">Nouvelle mesure</h3>
                        <button onclick="hideEntryForm()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">
                            ‚úï
                        </button>
                    </div>
                    
                    <!-- Moments (identique) -->
                    <div class="moment-options">
                        <div class="moment-option selected" data-moment="matin_jeun" onclick="selectMoment(this)">
                            <div style="font-size: 1.8rem;">üåÖ</div>
                            <div>Matin (√† jeun)</div>
                        </div>
                        <div class="moment-option" data-moment="midi" onclick="selectMoment(this)">
                            <div style="font-size: 1.8rem;">‚òÄÔ∏è</div>
                            <div>Midi</div>
                        </div>
                        <div class="moment-option" data-moment="soir" onclick="selectMoment(this)">
                            <div style="font-size: 1.8rem;">üåô</div>
                            <div>Soir</div>
                        </div>
                        <div class="moment-option" data-moment="autre" onclick="selectMoment(this)">
                            <div style="font-size: 1.8rem;">‚≠ê</div>
                            <div>Autre</div>
                        </div>
                    </div>
                    
                    <!-- Glyc√©mie -->
                    <div style="background: rgba(59,130,246,0.1); padding: 15px; border-radius: 10px; margin: 20px 0;">
                        <label style="display: block; margin-bottom: 10px; color: var(--secondary); font-weight: bold;">ü©∏ Glyc√©mie (g/L)</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <input type="number" id="glucoseValue" class="input-field" placeholder="1.20" step="0.01" style="font-size: 1.5rem; text-align: center;">
                            </div>
                            <div>
                                <input type="time" id="measureTime" class="input-field" style="font-size: 1.2rem; text-align: center;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- M√©dicaments -->
                    <div id="medicationSection">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <label style="color: var(--secondary); font-weight: bold;">üíä M√©dicaments</label>
                            <button onclick="addMedicationField()" style="background: rgba(59,130,246,0.3); border: none; padding: 8px 15px; border-radius: 8px; color: white; cursor: pointer;">
                                Ôºã Ajouter
                            </button>
                        </div>
                        <div id="medicationFields"></div>
                    </div>
                    
                    <!-- Repas -->
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin: 20px 0;">
                        <label style="display: block; margin-bottom: 10px; color: var(--secondary); font-weight: bold;">üçΩÔ∏è Repas (optionnel)</label>
                        <input type="text" id="mealType" class="input-field" placeholder="Type de repas (ex: Petit-d√©jeuner)">
                        <textarea id="mealContent" class="input-field" placeholder="Contenu du repas..." rows="3" style="resize: vertical;"></textarea>
                        <input type="time" id="mealTime" class="input-field">
                    </div>
                    
                    <!-- Commentaire -->
                    <div>
                        <label style="display: block; margin-bottom: 10px; color: var(--secondary); font-weight: bold;">üí¨ Commentaire</label>
                        <textarea id="comment" class="input-field" placeholder="Notes, ressenti..." rows="3" style="resize: vertical;"></textarea>
                    </div>
                    
                    <button onclick="saveEntry()" class="btn-primary" style="margin-top: 20px;">
                        ‚úÖ Enregistrer la mesure
                    </button>
                </div>
                
                <!-- Liste des entr√©es -->
                <div id="entriesList" style="margin-top: 20px;"></div>
            </div>
            
            <!-- Onglet Courbe -->
            <div id="tabChart" class="hidden">
                <div class="form-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--secondary);">Courbe glyc√©mique</h3>
                        <select id="chartPeriod" onchange="updateChart()" style="padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                            <option value="7">7 jours</option>
                            <option value="14">14 jours</option>
                            <option value="30">30 jours</option>
                        </select>
                    </div>
                    <canvas id="glucoseChart" style="width: 100%; height: 300px;"></canvas>
                </div>
            </div>
            
            <!-- Onglet Stats -->
            <div id="tabStats" class="hidden">
                <div class="form-card">
                    <h3 style="color: var(--secondary); margin-bottom: 20px;">Statistiques</h3>
                    <!-- Contenu stats -->
                </div>
            </div>
            
            <!-- Onglet Badges -->
            <div id="tabBadges" class="hidden">
                <div class="form-card">
                    <h3 style="color: var(--secondary); margin-bottom: 20px;">Badges</h3>
                    <div class="badge-grid">
                        <div id="badgeFirst" class="badge-card">
                            <div style="font-size: 2.5rem;">üéØ</div>
                            <div style="font-weight: bold; margin-top: 10px;">Premi√®re entr√©e</div>
                            <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Commencer le suivi</div>
                        </div>
                        <div id="badgeWeek" class="badge-card">
                            <div style="font-size: 2.5rem;">üî•</div>
                            <div style="font-weight: bold; margin-top: 10px;">7 jours</div>
                            <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Une semaine de suivi</div>
                        </div>
                        <div id="badgeFifty" class="badge-card">
                            <div style="font-size: 2.5rem;">‚≠ê</div>
                            <div style="font-weight: bold; margin-top: 10px;">50 entr√©es</div>
                            <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Expert du suivi</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bouton urgence -->
        <button onclick="showEmergency()" style="position: fixed; bottom: 20px; right: 20px; background: var(--danger); color: white; border: none; width: 60px; height: 60px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 15px rgba(239,68,68,0.4);">
            ‚ö†Ô∏è
        </button>
    </div>
    
    <!-- Script principal avec la LOGIQUE IDENTIQUE √† React -->
    <script>
        // === DONN√âES (identique √† React) ===
        let currentUser = null;
        let users = [];
        let entries = [];
        let allEntries = {};
        let streak = 0;
        let badges = [];
        let recentMeds = [];
        let recentMeals = [];
        let goals = { min: 0.7, max: 1.4, dailyMeasures: 4 };
        let selectedMoment = 'matin_jeun';
        
        const avatars = ['üë§', 'üë®', 'üßë', 'üë¥', 'üëµ', 'üßî', 'üë®‚Äç‚öïÔ∏è', 'üë©‚Äç‚öïÔ∏è'];
        
        // === INITIALISATION ===
        document.addEventListener('DOMContentLoaded', function() {
            // G√©n√©rer les avatars
            const avatarGrid = document.getElementById('avatarGrid');
            avatars.forEach(avatar => {
                const btn = document.createElement('button');
                btn.className = 'avatar-btn';
                btn.textContent = avatar;
                btn.onclick = function() {
                    document.querySelectorAll('.avatar-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                };
                avatarGrid.appendChild(btn);
            });
            
            // Charger les utilisateurs
            loadUsers();
        });
        
        // === STOCKAGE (similaire √† React) ===
        function saveToStorage(key, data) {
            localStorage.setItem(`glucotrack_${key}`, JSON.stringify(data));
        }
        
        function loadFromStorage(key) {
            const data = localStorage.getItem(`glucotrack_${key}`);
            return data ? JSON.parse(data) : null;
        }
        
        // === GESTION UTILISATEURS (identique) ===
        function loadUsers() {
            const savedUsers = loadFromStorage('users');
            if (savedUsers) {
                users = savedUsers;
                updateUserList();
            }
        }
        
        function updateUserList() {
            const container = document.getElementById('existingUsers');
            if (users.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = '<h3 style="margin-bottom: 15px; color: var(--secondary);">Profils existants :</h3>';
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.style.cssText = 'background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; gap: 15px;';
                userDiv.onclick = () => selectUser(user);
                userDiv.innerHTML = `
                    <div style="font-size: 2rem;">${user.avatar}</div>
                    <div>
                        <div style="font-weight: bold;">${user.name}</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">Continuer</div>
                    </div>
                `;
                container.appendChild(userDiv);
            });
        }
        
        function createUser() {
            const name = document.getElementById('userNameInput').value.trim();
            const selectedAvatar = document.querySelector('.avatar-btn.selected');
            
            if (!name || !selectedAvatar) {
                alert('Veuillez saisir un nom et s√©lectionner un avatar');
                return;
            }
            
            const newUser = {
                id: Date.now().toString(),
                name: name,
                avatar: selectedAvatar.textContent,
                createdAt: new Date().toISOString()
            };
            
            users.push(newUser);
            saveToStorage('users', users);
            selectUser(newUser);
        }
        
        function selectUser(user) {
            currentUser = user;
            document.getElementById('currentUserName').textContent = user.name;
            document.getElementById('currentUserAvatar').textContent = user.avatar;
            
            // Charger les donn√©es utilisateur
            loadUserData();
            
            // Passer √† l'application
            document.getElementById('userScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            refreshUI();
        }
        
        function showUserScreen() {
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('userScreen').classList.remove('hidden');
            updateUserList();
        }
        
        // === DONN√âES UTILISATEUR (identique) ===
        function loadUserData() {
            if (!currentUser) return;
            
            const userData = loadFromStorage(`user_${currentUser.id}`) || {};
            
            allEntries = userData.entries || {};
            streak = userData.streak || 0;
            badges = userData.badges || [];
            recentMeds = userData.recentMeds || [];
            recentMeals = userData.recentMeals || [];
            
            // Charger les entr√©es du jour
            const today = new Date().toISOString().split('T')[0];
            entries = allEntries[today] || [];
        }
        
        function saveUserData() {
            if (!currentUser) return;
            
            const userData = {
                entries: allEntries,
                streak: streak,
                badges: badges,
                recentMeds: recentMeds,
                recentMeals: recentMeals,
                goals: goals,
                lastUpdated: new Date().toISOString()
            };
            
            saveToStorage(`user_${currentUser.id}`, userData);
        }
        
        // === FORMULAIRE (identique √† React) ===
        function showEntryForm() {
            document.getElementById('entryForm').classList.remove('hidden');
            document.getElementById('addButton').classList.add('hidden');
            
            // Initialiser l'heure actuelle
            const now = new Date();
            document.getElementById('measureTime').value = 
                now.getHours().toString().padStart(2, '0') + ':' + 
                now.getMinutes().toString().padStart(2, '0');
        }
        
        function hideEntryForm() {
            document.getElementById('entryForm').classList.add('hidden');
            document.getElementById('addButton').classList.remove('hidden');
            resetForm();
        }
        
        function selectMoment(element) {
            document.querySelectorAll('.moment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedMoment = element.getAttribute('data-moment');
        }
        
        function addMedicationField() {
            const container = document.getElementById('medicationFields');
            const fieldId = Date.now();
            
            const fieldHTML = `
                <div id="medField_${fieldId}" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div style="color: var(--secondary); font-weight: bold;">M√©dicament</div>
                        <button onclick="removeMedicationField('${fieldId}')" style="background: none; border: none; color: var(--danger); cursor: pointer;">‚úï</button>
                    </div>
                    <input type="text" id="medName_${fieldId}" class="input-field" placeholder="Nom du m√©dicament" style="margin-bottom: 10px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="medDose_${fieldId}" class="input-field" placeholder="Dose">
                        <input type="time" id="medTime_${fieldId}" class="input-field">
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', fieldHTML);
        }
        
        function removeMedicationField(id) {
            document.getElementById(`medField_${id}`).remove();
        }
        
        function getMedicationsFromForm() {
            const medications = [];
            const fields = document.querySelectorAll('[id^="medField_"]');
            
            fields.forEach(field => {
                const id = field.id.replace('medField_', '');
                const name = document.getElementById(`medName_${id}`).value.trim();
                const dose = document.getElementById(`medDose_${id}`).value.trim();
                const time = document.getElementById(`medTime_${id}`).value;
                
                if (name) {
                    medications.push({ name, dose, time });
                }
            });
            
            return medications;
        }
        
        function resetForm() {
            document.getElementById('glucoseValue').value = '';
            document.getElementById('mealType').value = '';
            document.getElementById('mealContent').value = '';
            document.getElementById('mealTime').value = '';
            document.getElementById('comment').value = '';
            document.getElementById('medicationFields').innerHTML = '';
            
            // R√©initialiser le moment
            document.querySelectorAll('.moment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector('.moment-option[data-moment="matin_jeun"]').classList.add('selected');
            selectedMoment = 'matin_jeun';
        }
        
        // === SAUVEGARDE ENTR√âE (logique identique) ===
        function saveEntry() {
            const glucose = parseFloat(document.getElementById('glucoseValue').value);
            const measureTime = document.getElementById('measureTime').value;
            
            if (!glucose || !measureTime) {
                alert('Veuillez saisir la glyc√©mie et l\'heure de mesure');
                return;
            }
            
            // V√©rifier les alertes glyc√©miques (identique √† React)
            let alertMsg = '';
            let alertType = '';
            
            if (glucose < 0.6) {
                alertMsg = '‚ö†Ô∏è Hypoglyc√©mie s√©v√®re ! Consommez du sucre rapide imm√©diatement.';
                alertType = 'danger';
            } else if (glucose < 0.7) {
                alertMsg = '‚ö†Ô∏è Glyc√©mie basse. Surveillez votre √©tat.';
                alertType = 'warning';
            } else if (glucose > 2.5) {
                alertMsg = '‚ö†Ô∏è Hyperglyc√©mie s√©v√®re ! Consultez un m√©decin.';
                alertType = 'danger';
            } else if (glucose > 1.8) {
                alertMsg = '‚ö†Ô∏è Glyc√©mie √©lev√©e. Hydratez-vous.';
                alertType = 'warning';
            } else {
                alertMsg = '‚úÖ Glyc√©mie dans la norme !';
                alertType = 'success';
            }
            
            // Afficher l'alerte
            showAlert(alertMsg, alertType);
            
            // R√©cup√©rer les m√©dicaments
            const medications = getMedicationsFromForm();
            
            // Cr√©er l'entr√©e (identique √† React)
            const newEntry = {
                id: Date.now(),
                moment: selectedMoment,
                glucose: glucose,
                measureTime: measureTime,
                meal: document.getElementById('mealType').value,
                mealContent: document.getElementById('mealContent').value,
                mealTime: document.getElementById('mealTime').value,
                medications: medications,
                comment: document.getElementById('comment').value,
                timestamp: new Date().toISOString()
            };
            
            // Ajouter aux entr√©es du jour
            const today = new Date().toISOString().split('T')[0];
            if (!allEntries[today]) allEntries[today] = [];
            allEntries[today].push(newEntry);
            entries = allEntries[today];
            
            // Mettre √† jour les historiques (identique)
            medications.forEach(med => {
                if (med.name && !recentMeds.includes(med.name)) {
                    recentMeds.unshift(med.name);
                    if (recentMeds.length > 5) recentMeds.pop();
                }
            });
            
            const meal = document.getElementById('mealType').value;
            if (meal) {
                recentMeals = [meal, ...recentMeals.filter(m => m !== meal)].slice(0, 5);
            }
            
            // Mettre √† jour la s√©rie
            streak++;
            
            // V√©rifier les badges (identique)
            checkBadges();
            
            // Sauvegarder
            saveUserData();
            
            // R√©initialiser et fermer
            resetForm();
            hideEntryForm();
            refreshUI();
        }
        
        function showAlert(message, type) {
            // Cr√©er une alerte temporaire
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                padding: 15px 25px;
                border-radius: 10px;
                font-weight: bold;
                z-index: 1000;
                background: ${type === 'danger' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#10b981'};
                color: white;
                animation: slideIn 0.3s ease;
            `;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 4000);
        }
        
        // === BADGES (identique) ===
        function checkBadges() {
            const totalEntries = Object.values(allEntries).flat().length;
            const newBadges = [...badges];
            
            if (totalEntries >= 1 && !badges.includes('first')) {
                newBadges.push('first');
                showAlert('üéØ Badge d√©bloqu√© : Premi√®re entr√©e !', 'success');
            }
            if (streak >= 7 && !badges.includes('week')) {
                newBadges.push('week');
                showAlert('üî• Badge d√©bloqu√© : S√©rie de 7 jours !', 'success');
            }
            if (totalEntries >= 50 && !badges.includes('fifty')) {
                newBadges.push('fifty');
                showAlert('‚≠ê Badge d√©bloqu√© : 50 entr√©es !', 'success');
            }
            
            if (newBadges.length > badges.length) {
                badges = newBadges;
                saveUserData();
                updateBadgesDisplay();
            }
        }
        
        function updateBadgesDisplay() {
            document.getElementById('badgeFirst').className = badges.includes('first') ? 
                'badge-card unlocked' : 'badge-card';
            document.getElementById('badgeWeek').className = badges.includes('week') ? 
                'badge-card unlocked' : 'badge-card';
            document.getElementById('badgeFifty').className = badges.includes('fifty') ? 
                'badge-card unlocked' : 'badge-card';
        }
        
        // === AFFICHAGE ===
        function refreshUI() {
            const today = new Date().toISOString().split('T')[0];
            entries = allEntries[today] || [];
            
            // Mettre √† jour les stats
            document.getElementById('streakDisplay').textContent = streak + 'j';
            document.getElementById('todayCount').textContent = entries.length;
            document.getElementById('averageDisplay').textContent = calculateAverage().toFixed(1);
            document.getElementById('progressDisplay').textContent = 
                Math.min((entries.length / goals.dailyMeasures) * 100, 100).toFixed(0) + '%';
            
            // Afficher les entr√©es
            displayEntries();
            
            // Mettre √† jour les badges
            updateBadgesDisplay();
        }
        
        function calculateAverage() {
            if (entries.length === 0) return 0;
            const sum = entries.reduce((total, entry) => total + entry.glucose, 0);
            return sum / entries.length;
        }
        
        function displayEntries() {
            const container = document.getElementById('entriesList');
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            
            if (entries.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #94a3b8;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">üìä</div>
                        <p>Aucune mesure aujourd'hui</p>
                        <p style="font-size: 0.9rem;">Commencez votre suivi</p>
                    </div>
                `;
                return;
            }
            
            let filteredEntries = entries;
            if (searchTerm) {
                filteredEntries = entries.filter(entry => {
                    return (
                        entry.glucose.toString().includes(searchTerm) ||
                        entry.measureTime.includes(searchTerm) ||
                        (entry.meal && entry.meal.toLowerCase().includes(searchTerm)) ||
                        (entry.comment && entry.comment.toLowerCase().includes(searchTerm)) ||
                        entry.medications.some(m => m.name.toLowerCase().includes(searchTerm))
                    );
                });
            }
            
            container.innerHTML = '';
            filteredEntries.forEach(entry => {
                // D√©terminer la couleur (identique √† React)
                let glucoseColor = '#10b981'; // normal
                if (entry.glucose < 0.7) glucoseColor = '#ef4444'; // hypo
                if (entry.glucose > 1.8) glucoseColor = '#f59e0b'; // hyper
                
                // Ic√¥ne du moment
                let momentIcon = 'üåÖ';
                if (entry.moment === 'midi') momentIcon = '‚òÄÔ∏è';
                if (entry.moment === 'soir') momentIcon = 'üåô';
                if (entry.moment === 'autre') momentIcon = '‚≠ê';
                
                const entryHTML = `
                    <div class="entry-item">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="font-size: 1.8rem;">${momentIcon}</div>
                                <div>
                                    <div style="font-weight: bold; font-size: 1.2rem;">${entry.measureTime}</div>
                                    <div style="color: #94a3b8; font-size: 0.9rem;">
                                        ${entry.moment === 'matin_jeun' ? 'Matin (√† jeun)' : 
                                          entry.moment === 'midi' ? 'Midi' :
                                          entry.moment === 'soir' ? 'Soir' : 'Autre'}
                                    </div>
                                </div>
                            </div>
                            <div class="glucose-badge" style="background: linear-gradient(135deg, ${glucoseColor}, ${entry.glucose < 0.7 ? '#f87171' : entry.glucose > 1.8 ? '#fbbf24' : '#34d399'});">
                                ${entry.glucose}
                            </div>
                        </div>
                        
                        ${entry.medications.length > 0 ? `
                            <div style="margin-bottom: 10px;">
                                ${entry.medications.map(med => `
                                    <div style="background: rgba(59,130,246,0.1); padding: 8px 12px; border-radius: 8px; margin-bottom: 5px; font-size: 0.9rem;">
                                        üíä ${med.name} ‚Ä¢ ${med.dose} ‚Ä¢ ${med.time}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${entry.meal ? `
                            <div style="background: rgba(6,182,212,0.1); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                    <div style="color: var(--secondary);">üçΩÔ∏è</div>
                                    <strong>${entry.meal}</strong>
                                    ${entry.mealTime ? `<span style="margin-left: auto;">${entry.mealTime}</span>` : ''}
                                </div>
                                ${entry.mealContent ? `
                                    <div style="font-size: 0.9rem; color: #94a3b8;">${entry.mealContent}</div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        ${entry.comment ? `
                            <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem;">
                                üí¨ ${entry.comment}
                            </div>
                        ` : ''}
                        
                        <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
                            <button onclick="deleteEntry(${entry.id})" style="background: rgba(239,68,68,0.2); color: var(--danger); border: none; padding: 8px 15px; border-radius: 8px; font-size: 0.9rem; cursor: pointer;">
                                Supprimer
                            </button>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', entryHTML);
            });
        }
        
        function filterEntries() {
            displayEntries();
        }
        
        function deleteEntry(entryId) {
            if (!confirm('Supprimer cette mesure ?')) return;
            
            const today = new Date().toISOString().split('T')[0];
            allEntries[today] = allEntries[today].filter(entry => entry.id !== entryId);
            entries = allEntries[today] || [];
            
            saveUserData();
            refreshUI();
            showAlert('Mesure supprim√©e', 'success');
        }
        
        // === NAVIGATION ===
        function switchTab(tabName) {
            // Mettre √† jour les boutons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Afficher le bon onglet
            document.getElementById('tabToday').classList.add('hidden');
            document.getElementById('tabChart').classList.add('hidden');
            document.getElementById('tabStats').classList.add('hidden');
            document.getElementById('tabBadges').classList.add('hidden');
            
            document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.remove('hidden');
            
            if (tabName === 'chart') {
                // Initialiser le graphique si n√©cessaire
                setTimeout(initializeChart, 100);
            }
        }
        
        // === GRAPHIQUE ===
        function initializeChart() {
            // Code du graphique √† impl√©menter
            console.log('Initialisation du graphique');
        }
        
        function updateChart() {
            // Mettre √† jour le graphique
            console.log('Mise √† jour du graphique');
        }
        
        // === EXPORT ===
        function exportData() {
            const data = {
                user: currentUser,
                entries: allEntries,
                stats: {
                    streak: streak,
                    average: calculateAverage(),
                    badges: badges
                },
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', `GlucoTrack_${currentUser.name}_${new Date().toISOString().split('T')[0]}.json`);
            link.click();
            
            showAlert('‚úÖ Donn√©es export√©es', 'success');
        }
        
        // === URGENCE ===
        function showEmergency() {
            alert(`URGENCE DIAB√àTE

Glyc√©mie < 0.6 g/L (hypoglyc√©mie s√©v√®re) :
1. 15-20g de sucre rapide
2. Contr√¥ler apr√®s 15 minutes
3. Si pas d'am√©lioration : SAMU 15

Glyc√©mie > 2.5 g/L (hyperglyc√©mie s√©v√®re) :
1. Boire de l'eau
2. Ne pas faire d'exercice
3. Contacter m√©decin

Contacts :
‚Ä¢ SAMU : 15
‚Ä¢ Urgences : 112
‚Ä¢ Votre m√©decin : [NUM√âRO]`);
        }
        
        // Ajouter du CSS pour les animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { top: -100px; opacity: 0; }
                to { top: 20px; opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>