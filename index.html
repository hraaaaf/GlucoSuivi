<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlucoTrack - Suivi Diab√®te</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --primary: #3b82f6;
            --secondary: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #f8fafc;
            --text-light: #cbd5e1;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a, #1e40af);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        /* Header */
        .header {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .avatar {
            font-size: 2rem;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }
        
        /* Navigation */
        .tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            margin: 15px;
            padding: 5px;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            font-size: 14px;
            background: none;
            color: var(--text-light);
            border: none;
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
        }
        
        /* Contenu principal */
        .container {
            padding: 0 15px;
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Boutons */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin: 10px 0;
        }
        
        .btn-icon {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Formulaire */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary);
            font-weight: 600;
        }
        
        .form-input {
            width: 100%;
            padding: 14px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
        }
        
        .moment-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .moment-btn {
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
            text-align: center;
        }
        
        .moment-btn.active {
            background: rgba(59, 130, 246, 0.3);
            border-color: var(--primary);
        }
        
        /* Liste des entr√©es */
        .entry-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(30, 64, 175, 0.3));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .glucose-value {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            display: inline-block;
        }
        
        /* Alertes */
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 600;
            z-index: 1000;
            animation: slideDown 0.3s ease;
        }
        
        .alert-success { background: var(--success); }
        .alert-warning { background: var(--warning); }
        .alert-danger { background: var(--danger); }
        
        @keyframes slideDown {
            from { top: -100px; }
            to { top: 20px; }
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .stats { grid-template-columns: repeat(2, 1fr); }
            .moment-grid { grid-template-columns: 1fr; }
        }
        
        /* Loader */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div id="loader" class="loader">
        <div class="spinner"></div>
    </div>
    
    <!-- Alertes -->
    <div id="alert" class="alert" style="display: none;"></div>
    
    <!-- √âcran de s√©lection utilisateur -->
    <div id="userScreen" class="container" style="display: none; padding-top: 50px;">
        <div style="text-align: center; margin-bottom: 40px;">
            <h1 style="font-size: 2.5rem; background: linear-gradient(135deg, #3b82f6, #06b6d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px;">GlucoTrack</h1>
            <p style="color: var(--text-light);">S√©lectionnez un profil</p>
        </div>
        
        <div id="userList" style="margin-bottom: 30px;"></div>
        
        <div class="card">
            <h3 style="margin-bottom: 15px;">Nouveau profil</h3>
            <input type="text" id="newUserName" class="form-input" placeholder="Votre nom" style="margin-bottom: 15px;">
            <button onclick="createUser()" class="btn-primary">
                <i class="fas fa-plus"></i> Cr√©er profil
            </button>
        </div>
    </div>
    
    <!-- Application principale -->
    <div id="app" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="user-info">
                    <div class="avatar" id="currentAvatar">üë§</div>
                    <div>
                        <h2 id="currentUserName">Utilisateur</h2>
                        <small style="color: var(--text-light);">GlucoTrack</small>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-icon" onclick="exportData()" title="Exporter">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn-icon" onclick="switchUser()" title="Changer utilisateur">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <small>S√©rie</small>
                    <div style="font-size: 1.5rem; color: var(--primary);" id="streak">0j</div>
                </div>
                <div class="stat-card">
                    <small>Aujourd'hui</small>
                    <div style="font-size: 1.5rem; color: var(--secondary);" id="todayCount">0</div>
                </div>
                <div class="stat-card">
                    <small>Moyenne</small>
                    <div style="font-size: 1.5rem;" id="averageGlucose">0.0</div>
                </div>
                <div class="stat-card">
                    <small>Objectif</small>
                    <div style="font-size: 1.5rem; color: var(--primary);" id="dailyProgress">0%</div>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('today')">
                <i class="fas fa-calendar-day"></i> Aujourd'hui
            </button>
            <button class="tab" onclick="switchTab('chart')">
                <i class="fas fa-chart-line"></i> Courbe
            </button>
            <button class="tab" onclick="switchTab('stats')">
                <i class="fas fa-chart-bar"></i> Stats
            </button>
            <button class="tab" onclick="switchTab('badges')">
                <i class="fas fa-trophy"></i> Badges
            </button>
        </div>
        
        <!-- Contenu des onglets -->
        <div class="container">
            <!-- Onglet Aujourd'hui -->
            <div id="tabToday" class="tab-content">
                <div class="card">
                    <input type="text" id="searchInput" class="form-input" placeholder="üîç Rechercher..." oninput="searchEntries()">
                </div>
                
                <button id="addButton" class="btn-primary" onclick="showForm()">
                    <i class="fas fa-plus"></i> Nouvelle mesure
                </button>
                
                <!-- Formulaire -->
                <div id="entryForm" class="card" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Nouvelle mesure</h3>
                        <button class="btn-icon" onclick="hideForm()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üìÖ Moment</label>
                        <div class="moment-grid">
                            <button class="moment-btn active" data-moment="matin" onclick="selectMoment(this)">üåÖ Matin</button>
                            <button class="moment-btn" data-moment="midi" onclick="selectMoment(this)">‚òÄÔ∏è Midi</button>
                            <button class="moment-btn" data-moment="soir" onclick="selectMoment(this)">üåô Soir</button>
                            <button class="moment-btn" data-moment="autre" onclick="selectMoment(this)">‚≠ê Autre</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ü©∏ Glyc√©mie (g/L)</label>
                        <input type="number" id="glucoseInput" class="form-input" placeholder="1.20" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">‚è∞ Heure de mesure</label>
                        <input type="time" id="timeInput" class="form-input" value="">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üíä M√©dicaments (optionnel)</label>
                        <input type="text" id="medicationInput" class="form-input" placeholder="Nom du m√©dicament">
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <input type="text" id="medicationDose" class="form-input" placeholder="Dose" style="flex: 1;">
                            <input type="time" id="medicationTime" class="form-input" style="flex: 1;">
                        </div>
                        <button onclick="addMedication()" style="margin-top: 10px; padding: 10px; background: rgba(59,130,246,0.2); border: none; border-radius: 8px; color: white; width: 100%;">
                            <i class="fas fa-plus"></i> Ajouter m√©dicament
                        </button>
                        <div id="medicationList" style="margin-top: 10px;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üçΩÔ∏è Repas (optionnel)</label>
                        <input type="text" id="mealInput" class="form-input" placeholder="Type de repas">
                        <textarea id="mealContent" class="form-input" placeholder="Contenu du repas" rows="3" style="margin-top: 10px; resize: vertical;"></textarea>
                        <input type="time" id="mealTime" class="form-input" style="margin-top: 10px;">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üí¨ Commentaire</label>
                        <textarea id="commentInput" class="form-input" placeholder="Notes, ressenti..." rows="3" style="resize: vertical;"></textarea>
                    </div>
                    
                    <button class="btn-primary" onclick="saveEntry()">
                        <i class="fas fa-check"></i> Enregistrer
                    </button>
                </div>
                
                <!-- Liste des entr√©es -->
                <div id="entriesList" style="margin-top: 20px;"></div>
            </div>
            
            <!-- Onglet Courbe -->
            <div id="tabChart" class="tab-content" style="display: none;">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Courbe glyc√©mique</h3>
                        <select id="chartPeriod" onchange="updateChart()" style="padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                            <option value="7">7 jours</option>
                            <option value="14">14 jours</option>
                            <option value="30">30 jours</option>
                        </select>
                    </div>
                    <canvas id="glucoseChart" style="width: 100%; height: 300px;"></canvas>
                </div>
            </div>
            
            <!-- Onglet Stats -->
            <div id="tabStats" class="tab-content" style="display: none;">
                <div class="card">
                    <h3 style="margin-bottom: 20px;">Statistiques</h3>
                    
                    <div style="background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(6,182,212,0.2)); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="color: var(--text-light); margin-bottom: 5px;">Temps dans la cible (0.7-1.4 g/L)</div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--primary);" id="timeInRange">0%</div>
                        <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 10px;">
                            <div id="timeInRangeBar" style="height: 100%; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 4px; width: 0%;"></div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                        <div style="background: rgba(239,68,68,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: bold; color: var(--danger);" id="hypoCount">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">Hypoglyc√©mies</div>
                        </div>
                        <div style="background: rgba(16,185,129,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: bold; color: var(--success);" id="normalCount">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">Normales</div>
                        </div>
                        <div style="background: rgba(245,158,11,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: bold; color: var(--warning);" id="hyperCount">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">Hyperglyc√©mies</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Onglet Badges -->
            <div id="tabBadges" class="tab-content" style="display: none;">
                <div class="card">
                    <h3 style="margin-bottom: 20px;">Badges</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div id="badgeFirst" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; text-align: center; opacity: 0.3;">
                            <div style="font-size: 2rem;">üéØ</div>
                            <div style="font-weight: bold; margin-top: 10px;">Premi√®re entr√©e</div>
                        </div>
                        <div id="badgeWeek" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; text-align: center; opacity: 0.3;">
                            <div style="font-size: 2rem;">üî•</div>
                            <div style="font-weight: bold; margin-top: 10px;">7 jours</div>
                        </div>
                        <div id="badgeFifty" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; text-align: center; opacity: 0.3;">
                            <div style="font-size: 2rem;">‚≠ê</div>
                            <div style="font-weight: bold; margin-top: 10px;">50 entr√©es</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bouton d'urgence -->
        <button style="position: fixed; bottom: 20px; right: 20px; background: var(--danger); color: white; border: none; width: 60px; height: 60px; border-radius: 50%; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(239,68,68,0.4);" onclick="showEmergency()">
            <i class="fas fa-exclamation-triangle"></i>
        </button>
    </div>
    
    <!-- Script principal -->
    <script>
        // Donn√©es de l'application
        let currentUser = null;
        let users = [];
        let entries = [];
        let allEntries = {};
        let streak = 0;
        let badges = [];
        let medications = [];
        let selectedMoment = 'matin';
        let glucoseChart = null;
        
        // Fonctions de stockage
        function saveToStorage(key, data) {
            localStorage.setItem(`glucotrack_${key}`, JSON.stringify(data));
        }
        
        function loadFromStorage(key) {
            const data = localStorage.getItem(`glucotrack_${key}`);
            return data ? JSON.parse(data) : null;
        }
        
        // Initialisation
        window.onload = function() {
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                loadUsers();
            }, 1000);
        };
        
        // Gestion des utilisateurs
        function loadUsers() {
            users = loadFromStorage('users') || [];
            
            if (users.length > 0) {
                showUserList();
            } else {
                showUserScreen();
            }
        }
        
        function showUserList() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'entry-card';
                userDiv.style.cursor = 'pointer';
                userDiv.onclick = () => selectUser(user);
                userDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 2rem;">${user.avatar}</div>
                        <div>
                            <div style="font-weight: bold; font-size: 1.2rem;">${user.name}</div>
                            <div style="color: var(--text-light); font-size: 0.9rem;">Continuer</div>
                        </div>
                    </div>
                `;
                userList.appendChild(userDiv);
            });
            
            showUserScreen();
        }
        
        function showUserScreen() {
            document.getElementById('userScreen').style.display = 'block';
            document.getElementById('app').style.display = 'none';
        }
        
        function createUser() {
            const nameInput = document.getElementById('newUserName');
            const name = nameInput.value.trim();
            
            if (!name) {
                showAlert('Entrez un nom', 'warning');
                return;
            }
            
            const avatars = ['üë§', 'üë®', 'üßë', 'üë¥', 'üëµ', 'üßî', 'üë®‚Äç‚öïÔ∏è', 'üë©‚Äç‚öïÔ∏è'];
            const newUser = {
                id: Date.now().toString(),
                name: name,
                avatar: avatars[Math.floor(Math.random() * avatars.length)],
                createdAt: new Date().toISOString()
            };
            
            users.push(newUser);
            saveToStorage('users', users);
            selectUser(newUser);
            nameInput.value = '';
        }
        
        function selectUser(user) {
            currentUser = user;
            document.getElementById('currentUserName').textContent = user.name;
            document.getElementById('currentAvatar').textContent = user.avatar;
            
            loadUserData();
            showApp();
        }
        
        function switchUser() {
            showUserScreen();
        }
        
        function showApp() {
            document.getElementById('userScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            refreshData();
        }
        
        // Donn√©es utilisateur
        function loadUserData() {
            if (!currentUser) return;
            
            const userKey = `user_${currentUser.id}`;
            const data = loadFromStorage(userKey) || {
                entries: {},
                streak: 0,
                badges: [],
                medications: []
            };
            
            allEntries = data.entries || {};
            streak = data.streak || 0;
            badges = data.badges || [];
            medications = data.medications || [];
            
            // Mettre √† jour les entr√©es du jour
            const today = new Date().toISOString().split('T')[0];
            entries = allEntries[today] || [];
        }
        
        function saveUserData() {
            if (!currentUser) return;
            
            const userKey = `user_${currentUser.id}`;
            const data = {
                entries: allEntries,
                streak: streak,
                badges: badges,
                medications: medications,
                lastUpdated: new Date().toISOString()
            };
            
            saveToStorage(userKey, data);
        }
        
        // Interface
        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('alert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 4000);
        }
        
        function switchTab(tabName) {
            // Mettre √† jour les boutons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Afficher le bon contenu
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).style.display = 'block';
            
            if (tabName === 'chart') {
                setTimeout(() => {
                    if (glucoseChart) glucoseChart.destroy();
                    createChart();
                }, 100);
            } else if (tabName === 'stats') {
                updateStats();
            } else if (tabName === 'badges') {
                updateBadges();
            }
        }
        
        // Formulaire
        function showForm() {
            document.getElementById('entryForm').style.display = 'block';
            document.getElementById('addButton').style.display = 'none';
            document.getElementById('timeInput').value = new Date().toTimeString().substring(0, 5);
        }
        
        function hideForm() {
            document.getElementById('entryForm').style.display = 'none';
            document.getElementById('addButton').style.display = 'block';
        }
        
        function selectMoment(button) {
            document.querySelectorAll('.moment-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            selectedMoment = button.getAttribute('data-moment');
        }
        
        function addMedication() {
            const name = document.getElementById('medicationInput').value.trim();
            const dose = document.getElementById('medicationDose').value.trim();
            const time = document.getElementById('medicationTime').value;
            
            if (!name) {
                showAlert('Entrez un nom de m√©dicament', 'warning');
                return;
            }
            
            const list = document.getElementById('medicationList');
            const medDiv = document.createElement('div');
            medDiv.className = 'entry-card';
            medDiv.style.marginTop = '5px';
            medDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${name}</strong> ‚Ä¢ ${dose} ‚Ä¢ ${time}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: var(--danger);">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            list.appendChild(medDiv);
            
            // Sauvegarder dans les r√©cents
            if (!medications.includes(name)) {
                medications.push(name);
                if (medications.length > 5) medications.shift();
            }
            
            // R√©initialiser les champs
            document.getElementById('medicationInput').value = '';
            document.getElementById('medicationDose').value = '';
        }
        
        function saveEntry() {
            const glucose = parseFloat(document.getElementById('glucoseInput').value);
            const time = document.getElementById('timeInput').value;
            
            if (!glucose || !time) {
                showAlert('Glyc√©mie et heure requis', 'warning');
                return;
            }
            
            // Alerte glyc√©mie
            if (glucose < 0.6) {
                showAlert('‚ö†Ô∏è Hypoglyc√©mie s√©v√®re ! Sucre rapide imm√©diatement.', 'danger');
            } else if (glucose < 0.7) {
                showAlert('‚ö†Ô∏è Glyc√©mie basse. Surveillez votre √©tat.', 'warning');
            } else if (glucose > 2.5) {
                showAlert('‚ö†Ô∏è Hyperglyc√©mie s√©v√®re ! Consultez un m√©decin.', 'danger');
            } else if (glucose > 1.8) {
                showAlert('‚ö†Ô∏è Glyc√©mie √©lev√©e. Hydratez-vous.', 'warning');
            } else {
                showAlert('‚úÖ Glyc√©mie dans la norme !', 'success');
            }
            
            // Cr√©er l'entr√©e
            const entry = {
                id: Date.now(),
                moment: selectedMoment,
                glucose: glucose,
                time: time,
                meal: document.getElementById('mealInput').value,
                mealContent: document.getElementById('mealContent').value,
                mealTime: document.getElementById('mealTime').value,
                comment: document.getElementById('commentInput').value,
                timestamp: new Date().toISOString()
            };
            
            // Ajouter aux entr√©es du jour
            const today = new Date().toISOString().split('T')[0];
            if (!allEntries[today]) allEntries[today] = [];
            allEntries[today].push(entry);
            entries = allEntries[today];
            
            // Mettre √† jour la s√©rie
            streak++;
            
            // V√©rifier les badges
            checkBadges();
            
            // Sauvegarder
            saveUserData();
            
            // R√©initialiser le formulaire
            document.getElementById('glucoseInput').value = '';
            document.getElementById('mealInput').value = '';
            document.getElementById('mealContent').value = '';
            document.getElementById('mealTime').value = '';
            document.getElementById('commentInput').value = '';
            document.getElementById('medicationList').innerHTML = '';
            
            hideForm();
            refreshData();
        }
        
        // Affichage des donn√©es
        function refreshData() {
            const today = new Date().toISOString().split('T')[0];
            entries = allEntries[today] || [];
            
            // Mettre √† jour les stats
            document.getElementById('streak').textContent = streak + 'j';
            document.getElementById('todayCount').textContent = entries.length;
            document.getElementById('averageGlucose').textContent = calculateAverage().toFixed(1);
            document.getElementById('dailyProgress').textContent = Math.min((entries.length / 4) * 100, 100).toFixed(0) + '%';
            
            // Afficher les entr√©es
            displayEntries();
            
            // Mettre √† jour le graphique si actif
            if (document.getElementById('tabChart').style.display !== 'none') {
                if (glucoseChart) glucoseChart.destroy();
                createChart();
            }
        }
        
        function displayEntries() {
            const container = document.getElementById('entriesList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (entries.length === 0) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; color: var(--text-light); padding: 40px 20px;">
                        <i class="fas fa-heartbeat" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></i>
                        <p>Aucune mesure aujourd'hui</p>
                        <p style="font-size: 0.9rem;">Commencez votre suivi</p>
                    </div>
                `;
                return;
            }
            
            let filteredEntries = entries;
            if (searchTerm) {
                filteredEntries = entries.filter(entry => 
                    entry.glucose.toString().includes(searchTerm) ||
                    entry.comment.toLowerCase().includes(searchTerm) ||
                    entry.meal.toLowerCase().includes(searchTerm)
                );
            }
            
            container.innerHTML = '';
            filteredEntries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'entry-card';
                
                let momentIcon = 'üåÖ';
                if (entry.moment === 'midi') momentIcon = '‚òÄÔ∏è';
                if (entry.moment === 'soir') momentIcon = 'üåô';
                if (entry.moment === 'autre') momentIcon = '‚≠ê';
                
                let glucoseColor = 'var(--success)';
                if (entry.glucose < 0.7) glucoseColor = 'var(--danger)';
                if (entry.glucose > 1.8) glucoseColor = 'var(--warning)';
                
                entryDiv.innerHTML = `
                    <div class="entry-header">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="font-size: 1.8rem;">${momentIcon}</div>
                            <div>
                                <div style="font-weight: bold; font-size: 1.2rem;">${entry.time}</div>
                                <div style="color: var(--text-light); font-size: 0.9rem;">${entry.moment}</div>
                            </div>
                        </div>
                        <div class="glucose-value" style="background: linear-gradient(135deg, ${glucoseColor}, ${entry.glucose < 0.7 ? '#f87171' : entry.glucose > 1.8 ? '#fbbf24' : '#34d399'});">
                            ${entry.glucose}
                        </div>
                    </div>
                    
                    ${entry.meal ? `
                        <div style="margin-top: 10px; padding: 10px; background: rgba(6,182,212,0.1); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px; color: var(--secondary);">
                                <i class="fas fa-utensils"></i>
                                <strong>${entry.meal}</strong>
                                ${entry.mealTime ? `<span style="margin-left: auto;">${entry.mealTime}</span>` : ''}
                            </div>
                            ${entry.mealContent ? `<div style="margin-top: 5px; font-size: 0.9rem;">${entry.mealContent}</div>` : ''}
                        </div>
                    ` : ''}
                    
                    ${entry.comment ? `
                        <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.9rem;">
                            <i class="fas fa-comment"></i> ${entry.comment}
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 15px; display: flex; justify-content: flex-end;">
                        <button onclick="deleteEntry('${entry.id}')" style="background: rgba(239,68,68,0.2); color: var(--danger); border: none; padding: 8px 15px; border-radius: 8px; font-size: 0.9rem;">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                `;
                
                container.appendChild(entryDiv);
            });
        }
        
        function searchEntries() {
            displayEntries();
        }
        
        function deleteEntry(id) {
            if (!confirm('Supprimer cette mesure ?')) return;
            
            const today = new Date().toISOString().split('T')[0];
            allEntries[today] = allEntries[today].filter(entry => entry.id.toString() !== id);
            entries = allEntries[today] || [];
            
            saveUserData();
            refreshData();
            showAlert('Mesure supprim√©e', 'success');
        }
        
        // Calculs
        function calculateAverage() {
            if (entries.length === 0) return 0;
            const sum = entries.reduce((total, entry) => total + entry.glucose, 0);
            return sum / entries.length;
        }
        
        function checkBadges() {
            const totalEntries = Object.values(allEntries).flat().length;
            const newBadges = [...badges];
            
            if (totalEntries >= 1 && !badges.includes('first')) {
                newBadges.push('first');
                showAlert('üéØ Badge d√©bloqu√© : Premi√®re entr√©e !', 'success');
            }
            if (streak >= 7 && !badges.includes('week')) {
                newBadges.push('week');
                showAlert('üî• Badge d√©bloqu√© : S√©rie de 7 jours !', 'success');
            }
            if (totalEntries >= 50 && !badges.includes('fifty')) {
                newBadges.push('fifty');
                showAlert('‚≠ê Badge d√©bloqu√© : 50 entr√©es !', 'success');
            }
            
            if (newBadges.length > badges.length) {
                badges = newBadges;
                saveUserData();
                updateBadges();
            }
        }
        
        function updateBadges() {
            document.getElementById('badgeFirst').style.opacity = badges.includes('first') ? '1' : '0.3';
            document.getElementById('badgeWeek').style.opacity = badges.includes('week') ? '1' : '0.3';
            document.getElementById('badgeFifty').style.opacity = badges.includes('fifty') ? '1' : '0.3';
        }
        
        // Graphique
        function createChart() {
            const ctx = document.getElementById('glucoseChart').getContext('2d');
            const period = parseInt(document.getElementById('chartPeriod').value);
            
            const data = getChartData(period);
            
            glucoseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Glyc√©mie (g/L)',
                        data: data.values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 0,
                            max: 3,
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            },
                            ticks: {
                                color: '#cbd5e1'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            },
                            ticks: {
                                color: '#cbd5e1'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#f8fafc'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.9)',
                            titleColor: '#f8fafc',
                            bodyColor: '#f8fafc',
                            borderColor: 'rgba(59, 130, 246, 0.5)',
                            borderWidth: 1
                        }
                    }
                }
            });
            
            // Ajouter les lignes de r√©f√©rence
            Chart.helpers.each(glucoseChart.data.datasets.forEach(function(dataset, i) {
                const meta = glucoseChart.getDatasetMeta(i);
                Chart.helpers.each(meta.data.forEach(function(element, index) {
                    // Ajouter des points cliquables
                    element._model.radius = 6;
                }), glucoseChart);
            }), glucoseChart);
        }
        
        function getChartData(days) {
            const labels = [];
            const values = [];
            const now = new Date();
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(now.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                if (allEntries[dateStr] && allEntries[dateStr].length > 0) {
                    const dailyAvg = allEntries[dateStr].reduce((sum, entry) => sum + entry.glucose, 0) / allEntries[dateStr].length;
                    labels.push(dateStr.substring(5)); // Format "MM-JJ"
                    values.push(dailyAvg.toFixed(1));
                } else {
                    labels.push(dateStr.substring(5));
                    values.push(null);
                }
            }
            
            return { labels, values };
        }
        
        function updateChart() {
            if (glucoseChart) glucoseChart.destroy();
            createChart();
        }
        
        // Statistiques
        function updateStats() {
            const allData = Object.values(allEntries).flat();
            
            if (allData.length === 0) {
                document.getElementById('timeInRange').textContent = '0%';
                document.getElementById('timeInRangeBar').style.width = '0%';
                document.getElementById('hypoCount').textContent = '0';
                document.getElementById('normalCount').textContent = '0';
                document.getElementById('hyperCount').textContent = '0';
                return;
            }
            
            // Temps dans la cible
            const inRange = allData.filter(d => d.glucose >= 0.7 && d.glucose <= 1.4).length;
            const timeInRange = ((inRange / allData.length) * 100).toFixed(0);
            document.getElementById('timeInRange').textContent = timeInRange + '%';
            document.getElementById('timeInRangeBar').style.width = timeInRange + '%';
            
            // Compteurs
            document.getElementById('hypoCount').textContent = allData.filter(d => d.glucose < 0.7).length;
            document.getElementById('normalCount').textContent = allData.filter(d => d.glucose >= 0.7 && d.glucose <= 1.8).length;
            document.getElementById('hyperCount').textContent = allData.filter(d => d.glucose > 1.8).length;
        }
        
        // Export
        function exportData() {
            const dataStr = JSON.stringify({
                user: currentUser,
                entries: allEntries,
                stats: {
                    streak: streak,
                    average: calculateAverage(),
                    badges: badges
                }
            }, null, 2);
            
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `glucotrack_${currentUser.name}_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showAlert('‚úÖ Donn√©es export√©es en JSON', 'success');
        }
        
        // Urgence
        function showEmergency() {
            const emergencyMsg = `URGENCE DIAB√àTE

En cas d'hypoglyc√©mie s√©v√®re (<0.6 g/L) :
1. Consommez 15-20g de sucre rapide
2. Contr√¥lez apr√®s 15 minutes
3. Si pas d'am√©lioration, appelez le 15

En cas d'hyperglyc√©mie s√©v√®re (>2.5 g/L) :
1. Buvez de l'eau
2. Ne faites pas d'exercice
3. Consultez un m√©decin

Contacts d'urgence :
- M√©decin traitant : [NUM√âRO]
- SAMU : 15
- Urgences : 112`;

            alert(emergencyMsg);
        }
    </script>
</body>
</html>