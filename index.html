<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GlucoTrack Int√©gral</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-dark { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .custom-shadow { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .tab-active { background: #3b82f6; color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
        input[type="number"]::-webkit-inner-spin-button { display: none; }
    </style>
</head>
<body class="bg-slate-950 text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        const { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, 
            ResponsiveContainer, ReferenceLine, AreaChart, Area, Legend
        } = Recharts;

        // --- COMPOSANT ICONE DYNAMIQUE ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{width: size, height: size}} className={className}></i>;
        };

        const GlucoTrack = () => {
            // --- √âTATS GLOBAUX ---
            const [activeTab, setActiveTab] = useState('today');
            const [entries, setEntries] = useState([]);
            const [allEntries, setAllEntries] = useState({});
            const [showAddForm, setShowAddForm] = useState(false);
            const [showUserSelect, setShowUserSelect] = useState(true);
            const [currentUser, setCurrentUser] = useState(null);
            const [users, setUsers] = useState([]);
            const [newUserName, setNewUserName] = useState('');
            const [darkMode, setDarkMode] = useState(true);
            const [streak, setStreak] = useState(0);
            const [badges, setBadges] = useState([]);
            const [xp, setXp] = useState(0);
            const [loading, setLoading] = useState(true);

            // --- √âTATS FORMULAIRE ---
            const [formData, setFormData] = useState({
                moment: 'matin_jeun',
                glucose: '',
                measureTime: '',
                meal: 'none',
                mealContent: '',
                medications: [],
                comment: ''
            });

            // --- CHARGEMENT INITIAL ---
            useEffect(() => {
                const savedUsers = localStorage.getItem('gt_users_v2');
                if (savedUsers) setUsers(JSON.parse(savedUsers));
                setLoading(false);
            }, []);

            // Initialiser l'heure au clic
            useEffect(() => {
                if (showAddForm) {
                    setFormData(prev => ({ ...prev, measureTime: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) }));
                }
            }, [showAddForm]);

            // --- CHARGEMENT DONN√âES UTILISATEUR ---
            useEffect(() => {
                if (currentUser) {
                    const saved = localStorage.getItem(`gt_data_full_${currentUser.id}`);
                    if (saved) {
                        const d = JSON.parse(saved);
                        setAllEntries(d.allEntries || {});
                        setBadges(d.badges || []);
                        setXp(d.xp || 0);
                        setStreak(d.streak || 0);
                        const today = new Date().toISOString().split('T')[0];
                        setEntries(d.allEntries?.[today] || []);
                    }
                }
            }, [currentUser]);

            // --- ACTIONS ---
            const handleAddUser = () => {
                if (!newUserName.trim()) return;
                const newUser = { id: Date.now().toString(), name: newUserName, avatar: 'üë§', level: 1 };
                const updated = [...users, newUser];
                setUsers(updated);
                localStorage.setItem('gt_users_v2', JSON.stringify(updated));
                setCurrentUser(newUser);
                setShowUserSelect(false);
            };

            const saveEntry = () => {
                if (!formData.glucose) return;
                const today = new Date().toISOString().split('T')[0];
                const newEntry = {
                    ...formData,
                    id: Date.now(),
                    glucose: parseFloat(formData.glucose),
                    timestamp: new Date().toISOString()
                };

                const updatedDay = [...entries, newEntry];
                const updatedAll = { ...allEntries, [today]: updatedDay };
                const newXp = xp + 15;
                
                setEntries(updatedDay);
                setAllEntries(updatedAll);
                setXp(newXp);

                // Sauvegarde
                localStorage.setItem(`gt_data_full_${currentUser.id}`, JSON.stringify({
                    allEntries: updatedAll, badges, xp: newXp, streak
                }));
                
                setShowAddForm(false);
                setFormData({ moment: 'matin_jeun', glucose: '', measureTime: '', meal: 'none', mealContent: '', medications: [], comment: '' });
            };

            const deleteEntry = (id) => {
                const today = new Date().toISOString().split('T')[0];
                const updated = entries.filter(e => e.id !== id);
                setEntries(updated);
                const updatedAll = { ...allEntries, [today]: updated };
                setAllEntries(updatedAll);
                localStorage.setItem(`gt_data_full_${currentUser.id}`, JSON.stringify({ allEntries: updatedAll, badges, xp, streak }));
            };

            // --- RENDU √âCRAN CONNEXION ---
            if (showUserSelect) {
                return (
                    <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-8">
                        <div className="w-full max-w-sm space-y-10">
                            <div className="text-center space-y-2">
                                <h1 className="text-5xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-blue-500 via-cyan-400 to-emerald-400">GLUCO</h1>
                                <p className="text-slate-500 font-medium tracking-widest uppercase text-xs">Gestion Intelligente</p>
                            </div>
                            <div className="space-y-3">
                                {users.map(u => (
                                    <button key={u.id} onClick={() => {setCurrentUser(u); setShowUserSelect(false)}} 
                                            className="w-full glass p-6 rounded-3xl flex items-center gap-5 hover:bg-white/10 transition-all active:scale-95">
                                        <div className="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-600 to-blue-400 flex items-center justify-center text-2xl shadow-lg">
                                            {u.avatar}
                                        </div>
                                        <div className="text-left">
                                            <div className="font-bold text-lg text-white">{u.name}</div>
                                            <div className="text-xs text-slate-400">Utilisateur Premium</div>
                                        </div>
                                        <Icon name="chevron-right" className="ml-auto text-slate-600" />
                                    </button>
                                ))}
                            </div>
                            <div className="space-y-4 pt-6">
                                <input value={newUserName} onChange={e => setNewUserName(e.target.value)}
                                       className="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 outline-none focus:border-blue-500 transition-all text-center" 
                                       placeholder="Nouveau profil..." />
                                <button onClick={handleAddUser} className="w-full py-4 bg-white text-slate-950 rounded-2xl font-black text-sm uppercase tracking-tighter active:scale-95 transition-all">
                                    Cr√©er un profil
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- RENDU √âCRAN PRINCIPAL ---
            return (
                <div className={`min-h-screen ${darkMode ? 'bg-slate-950 text-white' : 'bg-slate-50 text-slate-900'} transition-colors duration-500`}>
                    
                    {/* Header Premium */}
                    <header className="px-6 pt-12 pb-6 space-y-6">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <div className="w-12 h-12 rounded-2xl bg-blue-600 flex items-center justify-center font-black shadow-xl shadow-blue-900/40">
                                    {currentUser.name[0]}
                                </div>
                                <div>
                                    <h2 className="font-extrabold text-xl tracking-tight">{currentUser.name}</h2>
                                    <div className="flex items-center gap-2">
                                        <div className="h-1.5 w-24 bg-white/10 rounded-full overflow-hidden">
                                            <div className="h-full bg-blue-500" style={{width: `${(xp % 100)}%`}}></div>
                                        </div>
                                        <span className="text-[10px] font-bold text-blue-500 uppercase">Niv. {Math.floor(xp/100) + 1}</span>
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setDarkMode(!darkMode)} className="w-10 h-10 glass rounded-xl flex items-center justify-center">
                                    <Icon name={darkMode ? 'sun' : 'moon'} size={18} />
                                </button>
                                <button onClick={() => setShowUserSelect(true)} className="w-10 h-10 glass rounded-xl flex items-center justify-center text-red-400">
                                    <Icon name="log-out" size={18} />
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="px-6 pb-32 space-y-8 max-w-lg mx-auto">
                        
                        {/* Barre d'onglets flottante */}
                        <div className="flex p-1.5 bg-white/5 rounded-2xl border border-white/5">
                            {['today', 'stats', 'badges'].map(t => (
                                <button key={t} onClick={() => setActiveTab(t)}
                                        className={`flex-1 py-3 rounded-xl text-xs font-black uppercase tracking-widest transition-all ${activeTab === t ? 'tab-active' : 'text-slate-500'}`}>
                                    {t === 'today' ? 'Journal' : t === 'stats' ? 'Analyse' : 'Badges'}
                                </button>
                            ))}
                        </div>

                        {activeTab === 'today' && (
                            <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                {/* Dashboard */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="glass p-6 rounded-[2rem] space-y-2 relative overflow-hidden group">
                                        <div className="absolute -right-2 -top-2 text-blue-500/10 group-hover:scale-110 transition-transform">
                                            <Icon name="activity" size={80} />
                                        </div>
                                        <p className="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Derni√®re</p>
                                        <p className="text-4xl font-black italic">{entries.length > 0 ? entries[entries.length-1].glucose : '--'}</p>
                                        <p className="text-xs font-bold text-blue-500">g/L</p>
                                    </div>
                                    <div className="glass p-6 rounded-[2rem] space-y-2">
                                        <p className="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Aujourd'hui</p>
                                        <p className="text-4xl font-black italic">{entries.length}</p>
                                        <p className="text-xs font-bold text-emerald-500">Mesures</p>
                                    </div>
                                </div>

                                {/* Bouton Ajouter */}
                                {!showAddForm ? (
                                    <button onClick={() => setShowAddForm(true)}
                                            className="w-full py-6 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-[2rem] font-black text-sm uppercase tracking-[0.2em] shadow-2xl shadow-blue-900/40 active:scale-[0.98] transition-all">
                                        + Ajouter Glyc√©mie
                                    </button>
                                ) : (
                                    <div className="glass p-8 rounded-[2.5rem] space-y-6 border-blue-500/30">
                                        <div className="flex justify-between items-center">
                                            <h3 className="font-black text-xl italic tracking-tighter">NOUVELLE ENTR√âE</h3>
                                            <button onClick={() => setShowAddForm(false)} className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center"><Icon name="x" size={16} /></button>
                                        </div>
                                        
                                        <div className="space-y-6">
                                            <div className="relative">
                                                <input type="number" step="0.01" value={formData.glucose} 
                                                       onChange={e => setFormData({...formData, glucose: e.target.value})}
                                                       className="w-full bg-white/5 p-8 rounded-3xl text-6xl font-black text-center text-blue-400 outline-none border-2 border-transparent focus:border-blue-500 transition-all" 
                                                       placeholder="0.00" autoFocus />
                                                <p className="text-center mt-2 text-slate-500 font-bold text-sm">Grammes par litre (g/L)</p>
                                            </div>

                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="space-y-2">
                                                    <label className="text-[10px] font-black text-slate-500 uppercase ml-2">Moment</label>
                                                    <select value={formData.moment} onChange={e => setFormData({...formData, moment: e.target.value})}
                                                            className="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold text-sm appearance-none border border-white/5">
                                                        <option value="matin_jeun">üåÖ √Ä jeun</option>
                                                        <option value="midi_avant">üçé Midi (Avant)</option>
                                                        <option value="midi_apres">üç± Midi (Apr√®s)</option>
                                                        <option value="soir_avant">ü•ó Soir (Avant)</option>
                                                        <option value="soir_apres">üçµ Soir (Apr√®s)</option>
                                                        <option value="nuit">üåå Nuit</option>
                                                    </select>
                                                </div>
                                                <div className="space-y-2">
                                                    <label className="text-[10px] font-black text-slate-500 uppercase ml-2">Heure</label>
                                                    <input type="time" value={formData.measureTime} 
                                                           onChange={e => setFormData({...formData, measureTime: e.target.value})}
                                                           className="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold text-sm border border-white/5" />
                                                </div>
                                            </div>

                                            <button onClick={saveEntry}
                                                    className="w-full py-5 bg-blue-600 rounded-2xl font-black text-sm uppercase tracking-widest shadow-xl active:scale-95 transition-all">
                                                Enregistrer
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {/* Timeline */}
                                <div className="space-y-4 pt-4">
                                    <div className="flex justify-between items-center px-2">
                                        <h4 className="text-xs font-black text-slate-500 uppercase tracking-widest">Historique du jour</h4>
                                        <Icon name="calendar" size={14} className="text-slate-600" />
                                    </div>
                                    {entries.length === 0 ? (
                                        <div className="glass p-10 rounded-[2rem] text-center text-slate-500 italic text-sm">
                                            Aucune donn√©e pour le moment
                                        </div>
                                    ) : (
                                        entries.slice().reverse().map(e => (
                                            <div key={e.id} className="group glass p-5 rounded-3xl flex items-center justify-between border border-white/5 hover:border-blue-500/30 transition-all">
                                                <div className="flex items-center gap-5">
                                                    <div className={`w-14 h-14 rounded-2xl flex flex-col items-center justify-center shadow-lg ${e.glucose > 1.4 ? 'bg-orange-500/10 text-orange-500' : e.glucose < 0.7 ? 'bg-red-500/10 text-red-500' : 'bg-emerald-500/10 text-emerald-500'}`}>
                                                        <span className="text-xl font-black">{e.glucose}</span>
                                                        <span className="text-[8px] font-bold uppercase opacity-60">g/L</span>
                                                    </div>
                                                    <div>
                                                        <div className="font-black text-lg">{e.measureTime}</div>
                                                        <div className="text-[10px] font-bold text-slate-500 uppercase tracking-tighter">
                                                            {e.moment.replace('_', ' ')}
                                                        </div>
                                                    </div>
                                                </div>
                                                <button onClick={() => deleteEntry(e.id)} className="p-3 text-slate-800 group-hover:text-red-500 transition-colors">
                                                    <Icon name="trash-2" size={18} />
                                                </button>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'stats' && (
                            <div className="space-y-6 animate-in fade-in duration-500">
                                <div className="glass p-6 rounded-[2.5rem] h-80 border-white/5">
                                    <h3 className="text-xs font-black text-slate-500 uppercase tracking-[0.2em] mb-6">Variation Glyc√©mique</h3>
                                    <ResponsiveContainer width="100%" height="80%">
                                        <AreaChart data={entries}>
                                            <defs>
                                                <linearGradient id="colorG" x1="0" y1="0" x2="0" y2="1">
                                                    <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.4}/>
                                                    <stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/>
                                                </linearGradient>
                                            </defs>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#ffffff05" vertical={false} />
                                            <XAxis dataKey="measureTime" hide />
                                            <YAxis domain={[0, 2]} hide />
                                            <Tooltip contentStyle={{background: '#0f172a', border: 'none', borderRadius: '16px', fontWeight: 'bold'}} />
                                            <Area type="monotone" dataKey="glucose" stroke="#3b82f6" strokeWidth={4} fillOpacity={1} fill="url(#colorG)" />
                                            <ReferenceLine y={1.4} stroke="#f97316" strokeDasharray="5 5" />
                                            <ReferenceLine y={0.7} stroke="#ef4444" strokeDasharray="5 5" />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="glass p-6 rounded-[2rem] text-center border-l-4 border-l-blue-500">
                                        <p className="text-[10px] font-black text-slate-500 uppercase mb-1">Stabilit√©</p>
                                        <p className="text-2xl font-black">92%</p>
                                    </div>
                                    <div className="glass p-6 rounded-[2rem] text-center border-l-4 border-l-purple-500">
                                        <p className="text-[10px] font-black text-slate-500 uppercase mb-1">Objectif</p>
                                        <p className="text-2xl font-black">4/4</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'badges' && (
                            <div className="grid grid-cols-2 gap-4 animate-in zoom-in-95 duration-500">
                                {[
                                    {id:'first', label:'Pionnier', desc:'1√®re mesure', icon:'award', color:'bg-yellow-500'},
                                    {id:'streak3', label:'R√©gulier', desc:'3j cons√©cutifs', icon:'zap', color:'bg-orange-500'},
                                    {id:'perfect', label:'Cible', desc:'10 mesures OK', icon:'target', color:'bg-emerald-500'},
                                    {id:'export', label:'Archiviste', desc:'1er export Excel', icon:'download', color:'bg-blue-500'}
                                ].map(b => (
                                    <div key={b.id} className={`glass p-6 rounded-[2rem] flex flex-col items-center text-center gap-3 transition-all ${badges.includes(b.id) ? 'opacity-100' : 'opacity-20 grayscale'}`}>
                                        <div className={`w-14 h-14 rounded-2xl ${b.color} flex items-center justify-center shadow-lg shadow-black/20`}>
                                            <Icon name={b.icon} size={28} className="text-white" />
                                        </div>
                                        <div>
                                            <p className="font-black text-sm">{b.label}</p>
                                            <p className="text-[10px] font-bold text-slate-500">{b.desc}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* Navigation Mobile Premium */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-slate-950/80 backdrop-blur-2xl border-t border-white/5 px-8 pt-4 pb-10 flex justify-around items-center z-50">
                        <button onClick={() => setActiveTab('today')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'today' ? 'text-blue-500 scale-110' : 'text-slate-600'}`}>
                            <Icon name="calendar" size={24} />
                            <span className="text-[9px] font-black uppercase tracking-tighter">Journal</span>
                        </button>
                        <button onClick={() => setActiveTab('stats')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'stats' ? 'text-blue-500 scale-110' : 'text-slate-600'}`}>
                            <Icon name="trending-up" size={24} />
                            <span className="text-[9px] font-black uppercase tracking-tighter">Stats</span>
                        </button>
                        <button onClick={() => setActiveTab('badges')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'badges' ? 'text-blue-500 scale-110' : 'text-slate-600'}`}>
                            <Icon name="award" size={24} />
                            <span className="text-[9px] font-black uppercase tracking-tighter">Badges</span>
                        </button>
                    </nav>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GlucoTrack />);
    </script>
</body>
</html>
